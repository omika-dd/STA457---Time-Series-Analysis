---
title: "STA457 Assignment"
author: 'Omika Dharamdasani, Student ID: 1000984483'
date: "August 05, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r dataImport, echo=FALSE, fig.width= 8, fig.height=4, fig.align='center'}
# use setwd to set your working directory and put the gasfur.csv there
 dat<-read.csv("gasfur.csv", header=TRUE)
 gas<-ts(dat[,1],freq=1, start=1)
 co2<-ts(dat[,2], freq=1, start=1)
 #head(dat)
#par(mar=c(3,3,1,1))
#plot(cbind(co2,gas), main="")
```

#### Model
Fit the following transfer function noise model
$$ co2_t =\alpha + \sum^s_{j} v_j \cdot gas_{t-j-b} + e_t,     (1)$$
where $e_t$ is serially correlated.

#### 1. Use the ideas of prewhitening taught in class to identify b and s. 
According the following figure, I identify that $b=3$ and $s=5$.
```{r}
# Type R codes used to produce the figure for identifying b and s
gas.ar <- arima(gas,c(5,0,0), include.mean = FALSE)
u.gas <- gas.ar$residuals
coefs <- gas.ar$coef
filt.co2 <- filter(co2, coefs, method = "recursive")
ccf <- ccf(u.gas, filt.co2, na.action=na.omit)
ccf
```

#### 2. Fit Eqn. (1) based on your preliminary identification and R arima function
Type the mathematical form of your model here 
$$ (1 - 0.4366B - 0.7188B^2 + 0.6158B^3)(1-B)co2_t = -0.0449gas(t-b-3) +0.0466gas(t-b-4) +0.0721gas(t-b-5) -0.4842(t-b-6) -0.6554(t-b-7) -0.9923gas(t-b-8) + (1+0.2723B -0.6173B^2)e_t $$

```{r}
# Show R codes that estimate your model and the corresponding estimation result
acf(co2)
pacf(co2)
# It looks like AR(4) or AR(2) could be used, but we will compare this against the model generated by auto.arima and some other models.

#install.packages("forecast")
library(forecast)

#Using auto.arima for preliminary analysis
reg <- cbind(lag(gas,-3), lag(gas,-4), lag(gas,-5), lag(gas,-6), lag(gas,-7), lag(gas,-8))
reg <- ts(reg, start=-2, end=293)

fit1 <- auto.arima(co2, xreg=reg)
fit1
#Identified as ARIMA(4,0,0). Carrying out analysis to see if a better model can be used instead:
fit2 <- arima(co2, c(2,0,0), xreg=reg, include.mean = FALSE)
fit3 <- arima(co2, c(4,0,1), xreg=reg, include.mean = FALSE)
fit4 <- arima(co2, c(3,1,2), xreg=reg, include.mean = FALSE)
fit5 <- arima(co2, c(3,1,0), xreg=reg, include.mean = FALSE)
aic1 <- fit1$aic
aic2 <- fit2$aic
aic3 <- fit3$aic
aic4 <- fit4$aic
aic5 <- fit5$aic
#Since ARIMA(3,1,2) has the highest log likelihood and lowest AIC, we will use this model.
Box.test(fit4$residuals, lag = 20, type = "Ljung-Box")
Box.test(fit4$residuals, lag = 20, type = "Box-Pierce")
# ARIMA (3,1,2) seems to be a good fit, because the p-values are high.

```

#### 3. Checking model adequacy of your fitted model.
The analysis of the model adequacy of the fitted model is as follows:

* e.g. My model pass the residual correlation check using the Box and Pierce and the Ljung Box test because the corresponding p-value is greater than 0.05 in both cases.

Box and Ljung: 0.9893 at lag 5
Box and Ljung: 0.5512 at lag 10
Box and Ljung: 0.4365 at lag 20

Box and Pierce: 0.9898 at lag 5
Box and Pierce: 0.5788 at lag 10
Box and Pierce: 0.5013 at lag 20

(testing at other values for lag also produced p-values > 0.05)
* e.g. The cross correlation between xx and xx .....

```{r}
# Show your R codes and results for checking model adequacy
acf(fit4$residuals, na.action = na.omit)
pacf(fit4$residuals, na.action = na.omit)
Box.test(fit4$residuals, lag = 20, type = "Ljung-Box")
Box.test(fit4$residuals, lag = 20, type = "Box-Pierce")
```
